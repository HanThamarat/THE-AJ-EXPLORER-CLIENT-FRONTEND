name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed

jobs:

  build:

    runs-on: self-hosted

    steps:
    - name: Set IMAGE_NAME variables
      run: |
        echo "IMAGE_NAME_THE_AJ_CLIENT_APP=hanthamarats/the-aj-explorer-client:latest" >> $GITHUB_ENV

    - name: Debug IMAGE_NAME variables
      run: |
        echo "IMAGE_NAME_THE_AJ_CLIENT_APP is $IMAGE_NAME_THE_AJ_CLIENT_APP"

    - name: Delete Old the-aj-explorer-client-app docker container
      run: sudo docker rm -f the-aj-explorer-client-app || true

    - name: Delete Old docker image
      run: sudo docker images | grep hanthamarats/the-aj-explorer-client | awk '{print $3}' | xargs sudo docker rmi || true

    - name: Pull Docker image
      run: sudo docker pull $IMAGE_NAME_THE_AJ_CLIENT_APP

    - name: Create Docker network (safe)
      run: sudo docker network create aj-network || echo "Network already exists âœ…"

    - name: Run Docker Backend Container
      env:
        SERVER_PORT: ${{secrets.SERVER_PORT}}
        PORT: ${{secrets.PORT}}
        NEXT_PUBLIC_API_URL: ${{secrets.NEXT_PUBLIC_API_URL}}
        NEXT_PUBLIC_AUTH_CALLBACK: ${{secrets.NEXT_PUBLIC_AUTH_CALLBACK}}
        NEXT_PUBLIC_WEB_SOCKET: ${{secrets.NEXT_PUBLIC_WEB_SOCKET}}
        NEXT_PUBLIC_GOOGLE_MAP_KEY: ${{secrets.NEXT_PUBLIC_GOOGLE_MAP_KEY}}
        NEXTAUTH_SECRET: ${{secrets.NEXTAUTH_SECRET}}
        NEXTAUTH_URL: ${{secrets.NEXTAUTH_URL}}
        AUTH_SECRET: ${{secrets.AUTH_SECRET}}
        AUTH_TRUST_HOST: ${{secrets.AUTH_TRUST_HOST}}
        GOOGLE_CLIENT_ID: ${{secrets.GOOGLE_CLIENT_ID}}
        GOOGLE_CLIENT_SECRET: ${{secrets.GOOGLE_CLIENT_SECRET}}
        NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${{secrets.NEXT_PUBLIC_GOOGLE_CLIENT_ID}}
        NEXT_PUBLIC_AUTH_URL: ${{secrets.NEXT_PUBLIC_AUTH_URL}}
        AUTH_BACKEND_SECRET: ${{secrets.AUTH_BACKEND_SECRET}}
      run: |
        sudo docker run -p $SERVER_PORT:$SERVER_PORT \
          -e NEXTAUTH_SECRET=$NEXTAUTH_SECRET \
          -e NEXTAUTH_URL=$NEXTAUTH_URL \
          -e AUTH_SECRET=$AUTH_SECRET \
          -e AUTH_TRUST_HOST=$AUTH_TRUST_HOST \
          -e GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID \
          -e GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET \
          -e NEXT_PUBLIC_GOOGLE_CLIENT_ID=$NEXT_PUBLIC_GOOGLE_CLIENT_ID \
          -e PORT=$PORT \
          -e NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL \
          -e NEXT_PUBLIC_AUTH_CALLBACK=$NEXT_PUBLIC_AUTH_CALLBACK \
          -e NEXT_PUBLIC_WEB_SOCKET=$NEXT_PUBLIC_WEB_SOCKET \
          -e NEXT_PUBLIC_GOOGLE_MAP_KEY=$NEXT_PUBLIC_GOOGLE_MAP_KEY \
          -e NEXT_PUBLIC_AUTH_URL=$NEXT_PUBLIC_AUTH_URL \
          -e AUTH_BACKEND_SECRET=$AUTH_BACKEND_SECRET \
          -d --name the-aj-explorer-client-app $IMAGE_NAME_THE_AJ_CLIENT_APP

    - name: Connect docker network
      run: sudo docker network connect aj-network the-aj-explorer-client-app